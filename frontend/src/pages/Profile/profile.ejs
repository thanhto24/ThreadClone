<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hồ sơ · Threads</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style/follow.css" />
  <link rel="stylesheet" href="/style/profile.css" />
  <link rel="stylesheet" href="/style/home.css" />
  <link rel="stylesheet" href="/style/navibar/navileft.css" />
  <link rel="stylesheet" href="/style/navibar/navitop.css">
  <link rel="stylesheet" href="/style/containerPost.css">
  <link rel="stylesheet" href="/style/plus.css">
  <link rel="stylesheet" href="/style/plusModal.css" />
  <link rel="stylesheet" href="/style/three_dots.css" />


  <script src="https://kit.fontawesome.com/434b26bb0d.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

</head>


<body>
  <%- include("../Partials/naviLeft.ejs") %>
    <!-- <iframe src="../Partials/naviLeft.ejs" style="border: none; width: 100%; height: 50px;"></iframe> -->


    <div class="container-fluid">
      <main>
        <%- include("../Partials/naviTop.ejs") %>
          <div class="content_wrapper">
            <div class="info_wrapper">
              <div class="info">
                <div class="name_wrapper">
                  <h1 class="user_name">User Name</h1>
                  <span class="user_handle">@user_name</span>
                </div>
                <img class="user_avatar"
                  src="https://th.bing.com/th/id/OIP.U0D5JdoPkQMi4jhiriSVsgHaHa?w=181&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7"
                  alt="User Avatar" />
              </div>
              <div class="bio">Xin chào Thread</div>
              <div class="info_with_link_wrapper">
                <a class="follower_wrapper" data-bs-toggle="modal" data-bs-target="#followersModal">
                  <i class="bi bi-people"></i>
                  <span class="follower_count">0</span>
                  <span class="follower_text">Người theo dõi</span>
                </a>
                <%- include("../Partials/followModal.ejs") %>
                  <div class="social_link_container">
                    <div class="social_link_wrapper">
                      <a href="https://www.facebook.com" target="_blank">
                        <span class="social_link_text">Facebook.com-link-to-fb-long-overflow</span>
                      </a>
                    </div>
                  </div>
                  <div class="profile_btn_wrapper">
                    <div class="insta_wrapper">
                      <a href="https://www.instagram.com" target="_blank" aria-label="Instagram">
                        <i class="bi bi-instagram" style="font-size: 1.5rem"></i>
                      </a>
                    </div>
                    <div class="option_wrapper">
                      <%- include("../Partials/three_dots_profile.ejs") %>
                    </div>
                  </div>
              </div>
            </div>
            <div class="edit_or_other_button" style="width: 100%"></div>
            <!-- <div class="edit">
              <button class="edit_btn" data-bs-toggle="modal" data-bs-target="#profileModal">Chỉnh sửa trang cá
                nhân</button>
            </div> -->

            <!--Edit Modal Structure -->
            <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel"
              aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-dialog-profile modal-dialog-centered-profile">
                <div class="modal-content modal-custom-profile" id="modal-1">
                  <div class="special_element_m">
                    <div class="element_m">
                      <div class="title_m">Tên</div>
                      <span id="editName" class="edit_profile_m">Username</span>
                      <hr class="line_m" />
                    </div>
                    <div class="avt_m">
                      <img
                        src="https://th.bing.com/th/id/OIP.U0D5JdoPkQMi4jhiriSVsgHaHa?w=181&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7"
                        alt="User Avatar" />
                    </div>
                  </div>


                  <div class="element_m">
                    <div class="title_m">Tiểu sử</div>
                    <span id="editBio" class="edit_profile_m">Xin chào Thread</span>
                  </div>

                  <hr class="line_m" />

                  <div class="element_m">
                    <div class="title_m">Liên kết</div>
                    <span id="link_social_m" class="edit_profile_m">Facebook.com-link-to-fb-long-overflow</span>
                  </div>

                  <hr class="line_m" />

                  <div class="special_element_m">
                    <div class="element_m">
                      <div class="title_m">Hiển thị biểu tượng Instagram</div>
                      <p>Khi bạn tắt, huy hiệu Threads trên trang cá nhân Instagram cũng sẽ biến mất.</p>
                    </div>
                    <div class="switch_btn_m form-switch">
                      <input class="form-check-input" type="checkbox" id="insta_btn_m">
                      <label class="switch_label" for="insta_btn_m"></label>
                    </div>

                  </div>

                  <hr class="line_m" />

                  <div class="special_element_m">
                    <div class="element_m">
                      <div class="title_m">Trang cá nhân riêng tư</div>
                      <p>Nếu chuyển sang chế độ riêng tư, bạn sẽ không thể trả lời người khác trừ khi họ theo dõi bạn.
                      </p>
                    </div>
                    <div class="switch_btn_m form-switch">
                      <input class="form-check-input" type="checkbox" id="private_btn_m">
                      <label class="switch_label" for="private_btn_m"></label>
                    </div>
                  </div>
                  <div class="done_btn_m">
                    <button type="button" data-bs-toggle="modal" data-bs-target="#profileModal"
                      onclick="update_User('1111')">Xong</button>
                  </div>
                </div>
              </div>
            </div>

            <!--Edit Extreme Modal Structure -->
            <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel2"
              aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-dialog-profile modal-dialog-centered-profile">
                <div class="modal-content modal-custom-profile" id="modal-2">
                  <div class="modal-header">
                    <div class="modal-2-header-btn">
                      <button type="button" class="btn" style="color: var(--white)" data-bs-dismiss="modal"
                        aria-label="Close">Hủy</button>
                    </div>
                    <h5 class="modal-title" id="editProfileModalLabel2">Chỉnh sửa trang cá nhân</h5>
                    <div class="modal-2-header-btn">
                      <button id="finish_button" type="button" class="btn" style="color: var(--white)"
                        data-bs-dismiss="modal" aria-label="Close">Xong</button>
                    </div>
                  </div>
                  <div class="modal-body">
                    <textarea name="profile_edit" id="profile_edit_m">Nhập thông tin bạn muốn thay đổi</textarea>
                    <span>Thông tin của bạn hiển thị công khai.</span>
                  </div>
                  <div class="modal-footer">
                    <a href="#">Nhập từ instagram</a>
                  </div>
                </div>
              </div>
            </div>





            <div class="tab_section">
              <a href="" id="thread">Thread</a>
              <a href="" id="reply">Thread trả lời</a>
              <a href="" id="repost">Bài đăng lại</a>
            </div>
            <div class="create_thread">
              <img
                src="https://th.bing.com/th/id/OIP.U0D5JdoPkQMi4jhiriSVsgHaHa?w=181&h=180&c=7&r=0&o=5&dpr=1.3&pid=1.7"
                alt="User Avatar" />
              <div id="post_status" class="create_thread_content">
                <span>Có gì mới?</span>
              </div>
              <button id="plus_box_short_profile">Đăng</button>
            </div>

            <div class="complete_profile_container">
              <div class="status">
                <h5>Hoàn tất trang cá nhân</h5>
                <span>Còn 1 mục</span>
              </div>

              <div class="mission_container" onscroll="handleScroll()">
                <button class="scroll-btn left" id="scrollLeftBtn" aria-label="scroll left" onclick="scrollToLeft()">
                  <i class="bi bi-arrow-left-circle-fill"></i>
                </button>
                <div class="mission">
                  <div class="mission_content">
                    <i class="bi bi-person-fill-add"></i>
                    <h3>Theo dõi 5 trang cá nhân</h3>
                    <p>Tạo điều kiện để bảng feed của bạn hiển thị những thread bạn quan tâm.</p>
                  </div>
                  <button class="add_mission_btn">Thêm</button>
                </div>

                <div class="mission">
                  <div class="mission_content">
                    <i class="bi bi-check"></i>
                    <h3>Thêm ảnh đại diện</h3>
                    <p>Giúp mọi người dễ dàng nhận ra bạn hơn.</p>
                  </div>
                  <button class="done_mission_btn">Xong</button>
                </div>

                <div class="mission">
                  <div class="mission_content">
                    <i class="bi bi-check"></i>
                    <h3>Tạo thread</h3>
                    <p>Cho mọi người biết bạn đang nghĩ gì hoặc chia sẻ về một hoạt động nổi bật mới đây.
                      Cho mọi người biết bạn đang nghĩ gì hoặc chia sẻ về một hoạt động nổi bật mới đây.
                      Cho mọi người biết bạn đang nghĩ gì hoặc chia sẻ về một hoạt động nổi bật mới đây.
                    </p>
                  </div>
                  <button class="done_mission_btn">Xong</button>
                </div>

                <div class="mission">
                  <div class="mission_content">
                    <i class="bi bi-check"></i>
                    <h3>Thêm tiểu sử</h3>
                    <p>Hãy giới thiệu về bản thân và cho mọi người biết bạn thích gì.</p>
                  </div>
                  <button class="done_mission_btn">Xong</button>
                </div>

                <button class="scroll-btn right" id="scrollRightBtn" aria-label="scroll right"
                  onclick="scrollToRight()">
                  <i class="bi bi-arrow-right-circle-fill"></i>
                </button>
              </div>
            </div>

            <!-- Post -->
            <div class="container_post" style="margin-top: 0;">
            </div>
          </div>
          <%- include("../Partials/plusIcon.ejs") %>
      </main>

      <%- include("../Partials/commentModal.ejs") %>
    </div>

</body>
<script>

  document.addEventListener('DOMContentLoaded', () => {
    // Xử lý cuộn container
    handleScroll();

    // Gán sự kiện cho nút chỉnh sửa
    handleEditButtons();

    // Gán sự kiện nút "Xong" trong modal
    const finishButton = document.querySelector('#editProfileModal #finish_button');
    if (finishButton) {
      finishButton.addEventListener('click', handleFinishEdit);
    }
  });

  window.onload = async () => {
    //lấy ý tưởng của nút button active để làm phần profile động, mỗi lần đăng nhập login thì lưu user_id của người đăng nhập vào localStorage.
    //Rồi lấy ra sài như biến global toàn frontend. chỉnh nút bấm thành code luôn nếu user_id trên URL là của người khác còn không có thì là profile
    //của chính bản thân. Mong Thanh chấp nhận cách code này.
    const urlParams = new URLSearchParams(window.location.search);
    let user_id = urlParams.get('user_id');
    const account_id = localStorage.getItem('account_id'); // Lấy account_id từ localStorage
    console.log(user_id);
    user_id = user_id ? user_id : account_id;

    // lấy trạng thái theo dõi:
    const user = await getUserData(account_id);
    let follow_status = "";
    if (user.following.includes(user_id)) {
      follow_status = "Đang theo dõi";
    } else {
      follow_status = "Theo dõi";
    }

    // Xử lý nút edit/other
    const edit_or_other_button = document.querySelector('.edit_or_other_button');
    const edit_or_other_button_respone = createButtonHTML(user_id, account_id, follow_status);
    edit_or_other_button.innerHTML = edit_or_other_button_respone.html;
    const edit_or_other_status = edit_or_other_button_respone.status;

    // Lấy dữ liệu người dùng
    const userData = await fetchUserData(user_id, edit_or_other_status);

    // Lấy danh sách bài viết và khởi tạo
    const posts_fetched = await getAllThreads(`user/${user_id}`);
    posts_fetched.forEach((post) => (post.user = userData));
    await createPost(posts_fetched);
    postInteract();

    followProcess(user_id)

    // thêm chức năng follow vs unfollow cho profile:
    document.querySelector('.other_profile_wrapper button').addEventListener('click', async (e) => {
      e.preventDefault();
      if (follow_status === "Theo dõi") {
        await followUser(user_id);
        window.location.reload();
      } else if (follow_status === "Đang theo dõi") {
        await unFollowUser(user_id);
        window.location.reload();
      }
    });

    //thay đổi trạng thái button follow: (sau khi thử cả trăm cách thì có cách này đc :<)
    button_follow = document.querySelector('.other_profile_wrapper button');

    if (button_follow.innerText.trim() === 'Đang theo dõi') {
      button_follow.innerHTML = 'Đang theo dõi';
      button_follow.style.backgroundColor = 'var(--black)';
      button_follow.style.color = 'var(--white)';
      button_follow.style.fontWeight = 'bold';
    } else {
      button_follow.innerHTML = 'Theo dõi';
      button_follow.style.backgroundColor = 'var(--white)';
      button_follow.style.color = 'var(--post)'; 
      button_follow.style.fontWeight = '500';
    }
  };

  // Xử lý cuộn container
  function handleScroll() {
    const container = document.querySelector('.mission_container');
    const scrollLeftBtn = document.getElementById('scrollLeftBtn');
    const scrollRightBtn = document.getElementById('scrollRightBtn');

    if (!container || !scrollLeftBtn || !scrollRightBtn) return;

    // Gán sự kiện cuộn container
    container.addEventListener('scroll', () => {
      if (container.scrollLeft <= 0) {
        scrollLeftBtn.classList.add('hidden');
      } else {
        scrollLeftBtn.classList.remove('hidden');
      }

      if (container.scrollLeft + container.clientWidth >= container.scrollWidth - 10) {
        scrollRightBtn.classList.add('hidden');
      } else {
        scrollRightBtn.classList.remove('hidden');
      }
    });
  }

  // Gán sự kiện cho các nút chỉnh sửa
  function handleEditButtons() {
    const edit_profile_m = document.querySelectorAll('.edit_profile_m');
    if (!edit_profile_m) return;

    edit_profile_m.forEach((element) => {
      element.addEventListener('click', () => {
        currentElement = element; // Lưu trữ phần tử hiện tại
        showEditModal();
      });
    });
  }

  // Xử lý cập nhật nội dung khi nhấn nút "Xong" trong modal
  function handleFinishEdit() {
    const modalElement = document.getElementById('editProfileModal');
    const textArea = document.getElementById('profile_edit_m');
    if (!modalElement || !textArea) return;

    const newContent = textArea.value;
    if (newContent !== 'Nhập thông tin bạn muốn thay đổi' && currentElement) {
      currentElement.innerText = newContent;
    }

    // Đóng modal
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) modal.hide();
  }

  // Hiển thị modal chỉnh sửa
  function showEditModal() {
    const modalElement = document.getElementById('editProfileModal');
    if (modalElement) {
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    } else {
      console.error('Modal element not found!');
    }
  }

</script>
<script src="/js/three_dots.js"></script>
<script src="/js/createPost.js"></script>
<script src="/js/Thread/getAllThread.js"></script>
<script src="/js/postWrap.js"></script>
<script src="/js/getUserData.js"></script>
<script src="/js/Profile/getUser.js"></script>
<script src="/js/Profile/updateUser.js"></script>
<script src="/js/profileButton.js"></script>
<script src="/js/Profile/follow.js"></script>

</html>